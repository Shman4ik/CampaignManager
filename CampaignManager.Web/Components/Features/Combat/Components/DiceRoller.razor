@using System.Security.Cryptography
@using CampaignManager.Web.Components.Shared

<div class="bg-white rounded-md shadow-sm border border-gray-200 p-4">
    <h3 class="text-lg font-semibold text-gray-900 mb-3">Бросок кубиков</h3>

    <div class="grid grid-cols-4 gap-2 mb-3">
        <Button Variant="secondary" Size="sm" OnClick="() => RollDice(100)">d100</Button>
        <Button Variant="secondary" Size="sm" OnClick="() => RollDice(10)">d10</Button>
        <Button Variant="secondary" Size="sm" OnClick="() => RollDice(6)">d6</Button>
        <Button Variant="secondary" Size="sm" OnClick="() => RollDice(4)">d4</Button>
    </div>

    <div class="mb-3">
        <label class="block text-xs font-medium text-gray-600 mb-1">Ручной ввод</label>
        <div class="flex gap-2">
            <input @bind="ManualInput" type="number"
                   class="border border-gray-300 rounded-md px-2 py-1 text-sm text-gray-700 w-full focus:outline-none focus:ring-1 focus:ring-blue-500"
                   placeholder="Значение" />
            <Button Variant="primary" Size="sm" OnClick="SetManualValue">Ввод</Button>
        </div>
    </div>

    @if (LastRollResult > 0)
    {
        <div class="bg-gray-50 border border-gray-200 rounded-md p-3 text-center">
            <div class="text-3xl font-bold text-gray-900 mb-1">@LastRollResult</div>
            <div class="text-xs text-gray-500">Последний результат</div>

            @if (TargetValue > 0)
            {
                <div class="mt-2 text-sm font-semibold @GetSuccessColor()">
                    @GetSuccessLevel()
                </div>
            }
        </div>
    }

    <div class="mt-3">
        <label class="block text-xs font-medium text-gray-600 mb-1">Значение навыка (необяз.)</label>
        <input @bind="TargetValue" type="number"
               class="border border-gray-300 rounded-md px-2 py-1 text-sm text-gray-700 w-full focus:outline-none focus:ring-1 focus:ring-blue-500"
               placeholder="Напр. 50" />
    </div>
</div>

@code {
    private int LastRollResult { get; set; }
    private int ManualInput { get; set; }
    private int TargetValue { get; set; }

    private void RollDice(int sides)
    {
        LastRollResult = RandomNumberGenerator.GetInt32(1, sides + 1);
    }

    private void SetManualValue()
    {
        LastRollResult = ManualInput;
    }

    private string GetSuccessLevel()
    {
        if (TargetValue <= 0) return "";

        if (LastRollResult == 1) return "Критический успех!";
        if (LastRollResult == 100) return "Провал!";
        if (LastRollResult >= 96 && TargetValue < 50) return "Провал!";

        if (LastRollResult <= TargetValue / 5) return "Экстремальный успех";
        if (LastRollResult <= TargetValue / 2) return "Сложный успех";
        if (LastRollResult <= TargetValue) return "Обычный успех";

        return "Неудача";
    }

    private string GetSuccessColor()
    {
        var level = GetSuccessLevel();
        return level switch
        {
            "Критический успех!" => "text-yellow-600",
            "Экстремальный успех" => "text-green-600",
            "Сложный успех" => "text-green-500",
            "Обычный успех" => "text-blue-600",
            "Неудача" => "text-red-500",
            "Провал!" => "text-red-700",
            _ => "text-gray-700"
        };
    }
}
