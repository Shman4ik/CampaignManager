@page "/combat"
@rendermode InteractiveServer
@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using CampaignManager.Web.Components.Features.Combat.Services
@using CampaignManager.Web.Components.Features.Combat.Model
@using CampaignManager.Web.Components.Features.Combat.Components
@using CampaignManager.Web.Components.Features.Characters.Services
@using CampaignManager.Web.Components.Features.Characters.Model
@using CampaignManager.Web.Components.Features.Bestiary.Services
@using CampaignManager.Web.Components.Features.Bestiary.Model
@using CampaignManager.Web.Components.Features.Campaigns.Models
@using CampaignManager.Web.Components.Features.Campaigns.Services
@using CampaignManager.Web.Components.Shared
@using CampaignManager.Web.Utilities.Services

@inject CombatService CombatService
@inject CreatureService CreatureService
@inject CampaignService CampaignService
@inject IdentityService IdentityService
@implements IDisposable

<PageTitle>Боевой помощник</PageTitle>

@if (!_isKeeper)
{
    <div class="max-w-7xl mx-auto px-2 py-4 font-sans">
        <Alert Type="error" Title="Доступ запрещён">
            Эта страница доступна только для мастера игры.
        </Alert>
    </div>
}
else
{
<div class="max-w-7xl mx-auto px-2 py-4 font-sans">
    <!-- Заголовок -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
        <h1 class="cm-h2">Боевой помощник</h1>
        <CampaignSelector OnCampaignSelected="HandleCampaignSelected" />
    </div>

    <!-- Панель раундов -->
    <div class="bg-white shadow-sm rounded-md border border-gray-200 p-3 mb-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <div class="flex items-center gap-4">
            <span class="text-sm font-semibold text-gray-800">Раунд: @CombatService.CurrentRound</span>
            <span class="text-sm text-gray-500">Ход: @(CombatService.CurrentTurnIndex + 1) / @Math.Max(1, CombatService.Combatants.Count)</span>
            @if (CombatService.GetActiveCombatant() != null)
            {
                <span class="text-sm font-medium text-blue-700">
                    → @CombatService.GetActiveCombatant()!.Name
                </span>
            }
        </div>
        <div class="flex gap-2">
            <Button Variant="primary" Size="sm" OnClick="NextTurn">Следующий ход</Button>
            <Button Variant="secondary" Size="sm" OnClick="NextRound">Следующий раунд</Button>
            <Button Variant="info" Size="sm" OnClick="SortInitiative">Сортировать ИН</Button>
        </div>
    </div>

    <!-- Три колонки -->
    <div class="grid grid-cols-12 gap-4">

        <!-- Левая: Список инициативы + Добавление -->
        <div class="col-span-12 lg:col-span-3 space-y-3">
            <!-- Участники -->
            <div class="bg-white shadow-sm rounded-md border border-gray-200 p-3">
                <h3 class="text-sm font-semibold text-gray-800 mb-2">Порядок инициативы</h3>
                <div class="max-h-[40vh] overflow-y-auto pr-1">
                    @if (CombatService.Combatants.Any())
                    {
                        @foreach (var combatant in CombatService.Combatants)
                        {
                            <CombatantCard Combatant="combatant"
                                           IsActive="@(combatant == CombatService.GetActiveCombatant())"
                                           OnRemoveCallback="RemoveCombatant" />
                        }
                    }
                    else
                    {
                        <p class="text-sm text-gray-400 text-center py-4">Нет участников</p>
                    }
                </div>
            </div>

            <!-- Добавить участника -->
            <div class="bg-white shadow-sm rounded-md border border-gray-200 p-3">
                <h3 class="text-sm font-semibold text-gray-800 mb-2">Добавить участника</h3>

                <div class="flex gap-1 mb-2">
                    <button @onclick='() => _showAddMode = "characters"'
                            class="px-2 py-1 text-xs rounded font-medium transition-colors @(_showAddMode == "characters" ? "bg-blue-100 text-blue-700" : "bg-gray-100 text-gray-600 hover:bg-gray-200")">
                        Персонажи
                    </button>
                    <button @onclick='() => _showAddMode = "creatures"'
                            class="px-2 py-1 text-xs rounded font-medium transition-colors @(_showAddMode == "creatures" ? "bg-red-100 text-red-700" : "bg-gray-100 text-gray-600 hover:bg-gray-200")">
                        Существа
                    </button>
                </div>

                <div class="max-h-[25vh] overflow-y-auto border border-gray-100 rounded-md">
                    @if (_showAddMode == "characters")
                    {
                        @if (_availableCharacters == null)
                        {
                            <p class="text-xs text-gray-400 p-2">@(_selectedCampaign == null ? "Выберите кампанию" : "Загрузка...")</p>
                        }
                        else if (!_availableCharacters.Any())
                        {
                            <p class="text-xs text-gray-400 p-2">Нет персонажей</p>
                        }
                        else
                        {
                            @foreach (var chara in _availableCharacters)
                            {
                                <div class="flex justify-between items-center px-2 py-1.5 hover:bg-blue-50 cursor-pointer text-sm border-b border-gray-50 last:border-0"
                                     @onclick="() => AddCharacter(chara)">
                                    <span class="text-gray-800">@chara.PersonalInfo.Name</span>
                                    <span class="text-xs text-gray-400">ЛВК @chara.Characteristics.Dexterity.Regular</span>
                                </div>
                            }
                        }
                    }
                    else
                    {
                        @if (_availableCreatures == null)
                        {
                            <p class="text-xs text-gray-400 p-2">Загрузка...</p>
                        }
                        else
                        {
                            @foreach (var monster in _availableCreatures)
                            {
                                <div class="flex justify-between items-center px-2 py-1.5 hover:bg-red-50 cursor-pointer text-sm border-b border-gray-50 last:border-0"
                                     @onclick="() => AddMonster(monster)">
                                    <span class="text-gray-800">@monster.Name</span>
                                    <span class="text-xs text-gray-400">ЛВК @monster.CreatureCharacteristics.Dexterity.Value</span>
                                </div>
                            }
                        }
                    }
                </div>
            </div>

            <Button Variant="error" FullWidth="true" Size="sm" OnClick="ResetCombat">Сбросить бой</Button>
        </div>

        <!-- Центральная: Панель действий -->
        <div class="col-span-12 lg:col-span-6 space-y-3">
            @if (CombatService.PendingResult != null)
            {
                <AttackResultDisplay Result="CombatService.PendingResult"
                                     OnApply="ApplyPendingResult"
                                     OnCancel="CancelPendingResult" />
            }
            else
            {
                <div class="bg-white shadow-sm rounded-md border border-gray-200 p-4">
                    <!-- Вкладки -->
                    <div class="flex gap-1 mb-4 border-b border-gray-200 pb-2">
                        <button @onclick='() => _activeTab = "attack"'
                                class="px-3 py-1.5 text-sm rounded-t font-medium transition-colors @(_activeTab == "attack" ? "bg-white border border-gray-200 border-b-white text-gray-900 -mb-[3px]" : "text-gray-500 hover:text-gray-700")">
                            Атака
                        </button>
                        <button @onclick='() => _activeTab = "sanity"'
                                class="px-3 py-1.5 text-sm rounded-t font-medium transition-colors @(_activeTab == "sanity" ? "bg-white border border-gray-200 border-b-white text-gray-900 -mb-[3px]" : "text-gray-500 hover:text-gray-700")">
                            Рассудок
                        </button>
                        <button @onclick='() => _activeTab = "dice"'
                                class="px-3 py-1.5 text-sm rounded-t font-medium transition-colors @(_activeTab == "dice" ? "bg-white border border-gray-200 border-b-white text-gray-900 -mb-[3px]" : "text-gray-500 hover:text-gray-700")">
                            Кубики
                        </button>
                    </div>

                    @if (_activeTab == "attack")
                    {
                        <AttackSetupPanel Combatants="CombatService.Combatants"
                                          OnAttackResolved="HandleAttackResolved" />
                    }
                    else if (_activeTab == "sanity")
                    {
                        <SanityCheckPanel Combatants="CombatService.Combatants"
                                          OnSanityResolved="HandleSanityResolved" />
                    }
                    else
                    {
                        <DiceRoller />
                    }
                </div>
            }
        </div>

        <!-- Правая: Боевой журнал -->
        <div class="col-span-12 lg:col-span-3">
            <CombatLog LogEntries="CombatService.CombatLog" />
        </div>
    </div>
</div>
}

@code {
    private bool _isKeeper;
    private string _showAddMode = "characters";
    private string _activeTab = "attack";
    private Campaign? _selectedCampaign;
    private List<Character>? _availableCharacters;
    private List<Creature>? _availableCreatures;

    protected override async Task OnInitializedAsync()
    {
        CombatService.OnChange += StateHasChanged;
        _isKeeper = await IdentityService.IsKeeper();

        if (_isKeeper)
        {
            _availableCreatures = await CreatureService.GetAllCreaturesAsync("", null, 1, 200);
        }
    }

    private async Task HandleCampaignSelected(Campaign? campaign)
    {
        _selectedCampaign = campaign;

        if (campaign != null)
        {
            CombatService.SetCampaign(campaign.Id);

            var fullCampaign = await CampaignService.GetCampaignWithCharactersAsync(campaign.Id);
            _availableCharacters = fullCampaign?.Players
                .SelectMany(p => p.Characters)
                .Where(c => c.Status == CharacterStatus.Active)
                .Select(c => c.Character)
                .ToList() ?? [];
        }
        else
        {
            _availableCharacters = null;
        }

        StateHasChanged();
    }

    private void AddCharacter(Character character)
    {
        CombatService.AddCombatant(new Combatant(character));
    }

    private void AddMonster(Creature creature)
    {
        CombatService.AddCombatant(new Combatant(creature));
    }

    private void RemoveCombatant(Combatant combatant)
    {
        CombatService.RemoveCombatant(combatant);
    }

    private void NextTurn() => CombatService.NextTurn();
    private void NextRound() => CombatService.NextRound();
    private void SortInitiative() => CombatService.SortByInitiative();
    private void ResetCombat() => CombatService.ResetCombat();

    private void HandleAttackResolved(CombatActionResult result)
    {
        CombatService.SetPendingResult(result);
    }

    private void HandleSanityResolved(CombatActionResult result)
    {
        CombatService.ApplyResult(result);
    }

    private void ApplyPendingResult()
    {
        if (CombatService.PendingResult != null)
            CombatService.ApplyResult(CombatService.PendingResult);
    }

    private void CancelPendingResult()
    {
        CombatService.CancelPendingResult();
    }

    public void Dispose()
    {
        CombatService.OnChange -= StateHasChanged;
    }
}
