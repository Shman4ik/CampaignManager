@using CampaignManager.Web.Components.Features.Weapons.Model
@using CampaignManager.Web.Components.Features.Weapons.Components
@using CampaignManager.Web.Components.Shared
@using CampaignManager.Web.Extensions
@namespace CampaignManager.Web.Components.Features.Weapons.Components

<div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
    <!-- Desktop Table View - Hidden on tablet/mobile; show only on xl+ -->
    <div class="hidden xl:block overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
                <SortableTableHeader 
                    Title="Название" 
                    FieldName="@nameof(Weapon.Name)"
                    CurrentSortField="@CurrentSortField"
                    SortAscending="@SortAscending"
                    OnSortChanged="OnSortChanged" />
                
                <SortableTableHeader 
                    Title="Тип" 
                    FieldName="@nameof(Weapon.Type)"
                    CurrentSortField="@CurrentSortField"
                    SortAscending="@SortAscending"
                    OnSortChanged="OnSortChanged" />
                
                <SortableTableHeader 
                    Title="Навык" 
                    FieldName="@nameof(Weapon.Skill)"
                    CurrentSortField="@CurrentSortField"
                    SortAscending="@SortAscending"
                    OnSortChanged="OnSortChanged" />
                
                <SortableTableHeader 
                    Title="Урон" 
                    FieldName="@nameof(Weapon.Damage)"
                    CurrentSortField="@CurrentSortField"
                    SortAscending="@SortAscending"
                    OnSortChanged="OnSortChanged" />
                
                <SortableTableHeader 
                    Title="Эпоха" 
                    FieldName="@nameof(Weapon.Is1920)"
                    CurrentSortField="@CurrentSortField"
                    SortAscending="@SortAscending"
                    OnSortChanged="OnSortChanged" />
                
                <th class="px-4 py-3 text-left font-medium text-gray-700">Характеристики</th>
                <th class="px-4 py-3 text-center font-medium text-gray-700">Действия</th>
            </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-100">
            @foreach (var weapon in Weapons)
            {
                <WeaponTableRow 
                    Weapon="@weapon"
                    IsExpanded="@(ExpandedWeaponId == weapon.Id)"
                    OnEdit="OnEdit"
                    OnDelete="OnDelete"
                    OnToggleExpand="() => OnToggleExpand.InvokeAsync(weapon)" />
            }
            </tbody>
        </table>
    </div>

    <!-- Mobile/Tablet Card View - Visible below xl -->
    <div class="xl:hidden">
        <div class="divide-y divide-gray-200">
            @foreach (var weapon in Weapons)
            {
                <div class="bg-white">
                    <!-- Card Header - Always visible -->
                    <div class="p-4 flex justify-between items-start gap-3 cursor-pointer active:bg-gray-50"
                         @onclick="() => OnToggleExpand.InvokeAsync(weapon)">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start gap-2 mb-2">
                                <button @onclick:stopPropagation="true" 
                                        @onclick="() => OnToggleExpand.InvokeAsync(weapon)"
                                        class="flex-shrink-0 w-8 h-8 flex items-center justify-center text-primary-600 hover:text-primary-800 hover:bg-primary-50 rounded transition-colors">
                                    <i class="fas @(ExpandedWeaponId == weapon.Id ? "fa-chevron-up" : "fa-chevron-down")"></i>
                                </button>
                                <div class="flex-1 min-w-0">
                                    <h3 class="font-semibold text-gray-900 text-base truncate">@weapon.Name</h3>
                                </div>
                            </div>
                            
                            <div class="ml-10">
                                <div class="text-sm text-gray-900 font-medium flex flex-wrap items-center gap-2">
                                    <span>@weapon.Skill</span>
                                    <span class="text-gray-400">•</span>
                                    <span>@weapon.Damage</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons - Always visible -->
                    <div class="px-4 pb-4 ml-10">
                        <div class="flex gap-2">
                            <button @onclick:stopPropagation="true" 
                                    @onclick="() => OnEdit.InvokeAsync(weapon)"
                                    class="flex-1 min-h-[44px] px-3 py-2 text-primary-600 hover:text-primary-800 bg-primary-50 hover:bg-primary-100 rounded-lg text-sm font-semibold flex items-center justify-center gap-2 transition-all duration-200 border border-primary-200 active:bg-primary-200">
                                <i class="fas fa-edit"></i>
                                <span>Изменить</span>
                            </button>
                            <button @onclick:stopPropagation="true" 
                                    @onclick="() => OnDelete.InvokeAsync(weapon)"
                                    class="flex-1 min-h-[44px] px-3 py-2 text-error-600 hover:text-error-800 bg-error-50 hover:bg-error-100 rounded-lg text-sm font-semibold flex items-center justify-center gap-2 transition-all duration-200 border border-error-200 active:bg-error-200">
                                <i class="fas fa-trash-alt"></i>
                                <span>Удалить</span>
                            </button>
                        </div>
                    </div>

                    <!-- Expandable Details -->
                    @if (ExpandedWeaponId == weapon.Id)
                    {
                        <div class="px-4 pb-4 ml-10 pt-2 border-t border-gray-200">
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="grid grid-cols-2 gap-x-6 gap-y-2 text-sm">
                                    <div>
                                        <div class="text-xs font-semibold text-gray-500 uppercase">Дистанция</div>
                                        <div class="text-gray-900">@weapon.Range</div>
                                    </div>
                                    <div>
                                        <div class="text-xs font-semibold text-gray-500 uppercase">Атаки</div>
                                        <div class="text-gray-900">@weapon.Attacks</div>
                                    </div>

                                    <div>
                                        <div class="text-xs font-semibold text-gray-500 uppercase">Тип/Эпоха</div>
                                        <div class="flex flex-wrap items-center gap-2 mt-0.5">
                                            <Badge Variant="primary" Size="sm" Rounded="md">@weapon.Type.ToRussianString()</Badge>
                                            @if (weapon.Is1920)
                                            {
                                                <Badge Variant="secondary" Size="sm" Rounded="md">1920s</Badge>
                                            }
                                            @if (weapon.IsModern)
                                            {
                                                <Badge Variant="secondary" Size="sm" Rounded="md">Modern</Badge>
                                            }
                                        </div>
                                    </div>

                                    @if (!string.IsNullOrEmpty(weapon.Cost))
                                    {
                                        <div>
                                            <div class="text-xs font-semibold text-gray-500 uppercase">Стоимость</div>
                                            <div class="text-gray-900">@weapon.Cost</div>
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(weapon.Ammo))
                                    {
                                        <div>
                                            <div class="text-xs font-semibold text-gray-500 uppercase">Боеприпасы</div>
                                            <div class="text-gray-900">@weapon.Ammo</div>
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(weapon.Malfunction))
                                    {
                                        <div>
                                            <div class="text-xs font-semibold text-gray-500 uppercase">Осечка</div>
                                            <div class="text-gray-900">@weapon.Malfunction</div>
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(weapon.Notes))
                                    {
                                        <div class="col-span-2">
                                            <div class="text-xs font-semibold text-gray-500 uppercase">Примечания</div>
                                            <div class="text-gray-700 whitespace-pre-wrap">@weapon.Notes</div>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public IEnumerable<Weapon> Weapons { get; set; } = Enumerable.Empty<Weapon>();
    [Parameter] public Guid? ExpandedWeaponId { get; set; }

    [Parameter] public string? CurrentSortField { get; set; }
    [Parameter] public bool SortAscending { get; set; }
    [Parameter] public EventCallback<string> OnSortChanged { get; set; }

    [Parameter] public EventCallback<Weapon> OnEdit { get; set; }
    [Parameter] public EventCallback<Weapon> OnDelete { get; set; }
    [Parameter] public EventCallback<Weapon> OnToggleExpand { get; set; }
}
