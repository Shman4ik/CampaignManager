@using CampaignManager.Web.Components.Features.Weapons.Model
@using CampaignManager.Web.Extensions
@namespace CampaignManager.Web.Components.Features.Weapons.Components

<div class="mb-3">
    <div class="flex flex-col sm:flex-row gap-2">
        <input type="text"
               value="@SearchQuery"
               @oninput="HandleSearchInput"
               placeholder="Поиск оружия..."
               class="flex-1 px-3 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary-500" />

        <select @onchange="HandleWeaponTypeChanged"
                class="px-3 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary-500">
            <option value="">Все типы</option>
            @foreach (var typeValue in EnumExtensions.GetWeaponTypes())
            {
                <option value="@typeValue" selected="@(SelectedTypeFilter == typeValue)">@typeValue.ToRussianString()</option>
            }
        </select>
    </div>
</div>

<div class="flex flex-wrap justify-between items-center gap-2 mb-1">
    <div class="flex flex-wrap items-center gap-3 sm:gap-4">
        <div class="flex items-center">
            <input type="checkbox"
                   id="era1920-weapons"
                   checked="@Is1920Filter"
                   @onchange="async e => await UpdateBoolAsync(Is1920FilterChanged, e)"
                   class="mr-1 h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded" />
            <label for="era1920-weapons" class="text-sm text-gray-700">1920s</label>
        </div>
        <div class="flex items-center">
            <input type="checkbox"
                   id="eraModern-weapons"
                   checked="@IsModernFilter"
                   @onchange="async e => await UpdateBoolAsync(IsModernFilterChanged, e)"
                   class="mr-1 h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded" />
            <label for="eraModern-weapons" class="text-sm text-gray-700">Modern</label>
        </div>
    </div>
</div>

@code {
    [Parameter] public string SearchQuery { get; set; } = string.Empty;
    [Parameter] public EventCallback<string> SearchQueryChanged { get; set; }

    [Parameter] public WeaponType? SelectedTypeFilter { get; set; }
    [Parameter] public EventCallback<WeaponType?> SelectedTypeFilterChanged { get; set; }

    [Parameter] public bool Is1920Filter { get; set; }
    [Parameter] public EventCallback<bool> Is1920FilterChanged { get; set; }

    [Parameter] public bool IsModernFilter { get; set; }
    [Parameter] public EventCallback<bool> IsModernFilterChanged { get; set; }

    [Parameter] public EventCallback OnFiltersChanged { get; set; }

    private async Task HandleSearchInput(ChangeEventArgs e)
    {
        var text = e.Value?.ToString() ?? string.Empty;
        await SearchQueryChanged.InvokeAsync(text);
        await OnFiltersChanged.InvokeAsync();
    }

    private async Task HandleWeaponTypeChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        WeaponType? parsed = null;
        if (!string.IsNullOrEmpty(value) && Enum.TryParse<WeaponType>(value, out var typeValue))
        {
            parsed = typeValue;
        }
        await SelectedTypeFilterChanged.InvokeAsync(parsed);
        await OnFiltersChanged.InvokeAsync();
    }

    private async Task UpdateBoolAsync(EventCallback<bool> callback, ChangeEventArgs e)
    {
        var str = e.Value?.ToString();
        var val = string.Equals(str, "true", StringComparison.OrdinalIgnoreCase) || string.Equals(str, "on", StringComparison.OrdinalIgnoreCase);
        await callback.InvokeAsync(val);
        await OnFiltersChanged.InvokeAsync();
    }
}
