@page "/character/create/{CampaignId:guid}"
@page "/character/create/{CampaignId:guid}/{npc}"
@page "/character/create/{npc}"
@page "/character/{CharacterId:guid}"
@using CampaignManager.Web.Components.Features.Campaigns.Models
@using CampaignManager.Web.Components.Features.Characters.Model
@using CampaignManager.Web.Components.Features.Characters.Services
@using CampaignManager.Web.Components.Features.Weapons.Model
@using CampaignManager.Web.Utilities.Services
@using CampaignManager.Web.Components.Features.Characters.Components
@attribute [Authorize]

@inject CharacterService CharacterService
@inject NavigationManager NavigationManager
@inject CharacterGenerationService CharacterGenerationService
@inject IJSRuntime JsRuntime
@inject PdfExportService PdfExportService
@rendermode InteractiveServer

<PageTitle>@(Character?.PersonalInfo.Name ?? (IsNpc ? "Новый NPC" : "Новый персонаж"))</PageTitle>

<ErrorBoundary @ref="_errorBoundary">
    <ChildContent>
        <!-- Modern header with navigation -->
        <div class="sticky top-0 z-50 w-full bg-white shadow-md mb-6">
            <div class="max-w-7xl mx-auto px-4 py-3">
                <!-- Character name and actions area -->
                <div class="flex justify-between items-center w-full mb-2">
                    <div class="flex items-center gap-2 min-w-0 flex-1">
                        <h3 class="cm-h3 truncate">
                            @(Character?.PersonalInfo.Name ?? (IsNpc ? "Новый NPC" : "Новый персонаж"))
                        </h3>
                        @if (IsNpc)
                        {
                            <span class="ml-2 text-xs px-2 py-0.5 bg-purple-600 text-white rounded-full font-medium flex-shrink-0">NPC</span>
                        }
                    </div>
                    <!-- Redesigned adaptive navigation menu -->
                    <div class="ml-2 flex items-center gap-1 sm:gap-2 flex-shrink-0">
                        <!-- Mobile dropdown menu (visible on small screens) -->
                        <div class="relative sm:hidden">
                            <button @onclick="ToggleNavMenu" type="button"
                                    class="flex items-center justify-center p-2 text-gray-600 hover:text-blue-700 rounded-md transition-colors">
                                <i class="fa-solid fa-bars"></i>
                            </button>
                            @if (_navMenuOpen)
                            {
                                <div
                                    class="absolute right-0 top-full mt-1 bg-white shadow-lg rounded-md overflow-hidden z-20 w-36 py-1">
                                    <button @onclick='()  =>  ScrollToSection("personal")'
                                            class="w-full text-left px-3 py-2 hover:bg-blue-50 text-gray-700 flex items-center">
                                        <i class="fa-solid fa-user w-5 text-blue-500"></i>
                                        <span class="ml-2">Персонаж</span>
                                    </button>
                                    <button @onclick='() =>  ScrollToSection("skills") '
                                            class="w-full text-left px-3 py-2 hover:bg-blue-50 text-gray-700 flex items-center">
                                        <i class="fa-solid fa-graduation-cap w-5 text-blue-500"></i>
                                        <span class="ml-2">Навыки</span>
                                    </button>
                                    <button @onclick='() =>  ScrollToSection("combat")'
                                            class="w-full text-left px-3 py-2 hover:bg-blue-50 text-gray-700 flex items-center">
                                        <i class="fa-solid fa-gun w-5 text-blue-500"></i>
                                        <span class="ml-2">Бой</span>
                                    </button>
                                    <button @onclick='() =>  ScrollToSection("equipment")'
                                            class="w-full text-left px-3 py-2 hover:bg-blue-50 text-gray-700 flex items-center">
                                        <i class="fa-solid fa-suitcase w-5 text-blue-500"></i>
                                        <span class="ml-2">Снаряжение</span>
                                    </button>
                                    <button @onclick='() =>  ScrollToSection("biography")'
                                            class="w-full text-left px-3 py-2 hover:bg-blue-50 text-gray-700 flex items-center">
                                        <i class="fa-solid fa-book w-5 text-blue-500"></i>
                                        <span class="ml-2">Биография</span>
                                    </button>
                                </div>
                            }
                        </div>

                        <!-- Desktop navigation (visible on larger screens) -->
                        <div class="hidden sm:flex space-x-1 bg-gray-100 rounded-lg p-1">
                            <button type="button" @onclick='() => ScrollToSection("personal")'
                                    class="text-gray-600 hover:text-blue-700 hover:bg-white py-1 px-2 text-sm font-medium rounded-md flex items-center transition-colors">
                                <i class="fa-solid fa-user"></i>
                                <span class="ml-1 hidden md:inline">Персонаж</span>
                            </button>
                            <button type="button" @onclick='() => ScrollToSection("skills")'
                                    class="text-gray-600 hover:text-blue-700 hover:bg-white py-1 px-2 text-sm font-medium rounded-md flex items-center transition-colors">
                                <i class="fa-solid fa-graduation-cap"></i>
                                <span class="ml-1 hidden md:inline">Навыки</span>
                            </button>
                            <button type="button" @onclick='() => ScrollToSection("combat")'
                                    class="text-gray-600 hover:text-blue-700 hover:bg-white py-1 px-2 text-sm font-medium rounded-md flex items-center transition-colors">
                                <i class="fa-solid fa-gun"></i>
                                <span class="ml-1 hidden md:inline">Бой</span>
                            </button>
                            <button type="button" @onclick='() => ScrollToSection("equipment")'
                                    class="text-gray-600 hover:text-blue-700 hover:bg-white py-1 px-2 text-sm font-medium rounded-md flex items-center transition-colors">
                                <i class="fa-solid fa-suitcase"></i>
                                <span class="ml-1 hidden md:inline">Снаряжение</span>
                            </button>
                            <button type="button" @onclick='() => ScrollToSection("biography")'
                                    class="text-gray-600 hover:text-blue-700 hover:bg-white py-1 px-2 text-sm font-medium rounded-md flex items-center transition-colors">
                                <i class="fa-solid fa-book"></i>
                                <span class="ml-1 hidden md:inline">Биография</span>
                            </button>
                        </div>

                        <div class="flex gap-1 sm:gap-2 ml-2">
                            <Button Variant="success" OnClick="SaveCharacterAsync" Icon="fa-regular fa-floppy-disk" />
                            @if (CharacterId == null || CharacterId == Guid.Empty)
                            {
                                <Button Variant="info" OnClick="GenerateRandom">
                                    <span class="hidden sm:inline">Случайный</span>
                                    <i class="fa-solid fa-dice sm:hidden"></i>
                                </Button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main content area -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6">
            @if (!string.IsNullOrEmpty(_notification.Message))
            {
                <NotificationAlert Type="@_notification.Type" Message="@_notification.Message"
                                   OnClose="ClearNotification"/>
            }

            @if (_isLoading)
            {
                <div class="flex justify-center p-12">
                    <LoadingIndicator/>
                </div>
            }
            else if (Character != null)
            {
                <EditForm Model="Character" FormName="CharacterForm">
                    <DataAnnotationsValidator/>

                    <!-- Персональная информация -->
                    <div id="personal" class="mb-8">
                        <div class="bg-white rounded-lg overflow-hidden shadow-sm">
                            <div
                                class="section-header px-4 py-2 bg-gradient-to-r from-primary-600 to-primary-700 flex justify-between items-center cursor-pointer select-none"
                                @onclick='() => ToggleSectionVisibility("personal")'>
								<div class="flex items-center space-x-3">
                                    <i class="fa-solid fa-user text-white/70"></i>
									<h3 class="text-lg font-semibold text-white" style="margin-bottom: 0;">Личные данные</h3>
									<div @onclick:stopPropagation="true">
										@if (CharacterStorageDto != null)
										{
											<CharacterStatusChanger CharacterId="@CharacterStorageDto.Id" CurrentStatus="@CharacterStorageDto.Status" OnStatusUpdated="@HandleStatusUpdate" />					
										}
									</div>
								</div>
                                <span class="text-white/70 text-sm transition-transform duration-200">@(_sectionVisibility["personal"] ? "▲" : "▼")</span>
                            </div>
                            @if (_sectionVisibility["personal"])
                            {
                                <div class="p-1">
                                    <UnifiedPersonalInfoCard 
                                        Character="@Character" 
                                        CharacterStorageDto="@CharacterStorageDto"
                                        OnStatusUpdated="@HandleStatusUpdate"
                                        OnCharacteristicUpdate="@UpdateCharacteristic" />
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Секция Навыки -->
                    <div id="skills" class="mb-8">
                        <div class="bg-white rounded-lg overflow-hidden shadow-sm">
                            <div
                                class="section-header px-4 py-2 bg-gradient-to-r from-primary-600 to-primary-700 flex justify-between items-center cursor-pointer select-none"
                                @onclick='() => ToggleSectionVisibility("skills")'>
                                <div class="flex items-center space-x-3">
                                    <i class="fa-solid fa-graduation-cap text-white/70"></i>
                                    <h3 class="text-lg font-semibold text-white" style="margin-bottom: 0;">Навыки</h3>
                                    <div @onclick:stopPropagation="true">
                                        <Button Variant="info" Size="sm" OnClick="ResetUsedSkills" AdditionalClasses="text-xs leading-tight">
                                            Сбросить
                                        </Button>
                                    </div>
                                </div>
                                <span class="text-white/70 text-sm transition-transform duration-200">@(_sectionVisibility["skills"] ? "▲" : "▼")</span>
                            </div>
                            @if (_sectionVisibility["skills"])
                            {
                                <div class="p-4">
                                    <!-- Поле поиска навыков -->
                                    <div class="mb-4">
                                        <div class="relative">
                                            <input type="text"
                                                   @bind="_skillSearchQuery"
                                                   @bind:event="oninput"
                                                   placeholder="Поиск навыков..."
                                                   class="w-full px-4 py-2.5 pl-10 border border-gray-300 rounded-lg shadow-sm bg-white focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-shadow" />
                                            <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                            @if (!string.IsNullOrWhiteSpace(_skillSearchQuery))
                                            {
                                                <button @onclick="ClearSkillSearch"
                                                        class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                                    <i class="fa-solid fa-times"></i>
                                                </button>
                                            }
                                        </div>
                                    </div>

                                    @{
                                        var filteredGroups = GetFilteredSkillGroups();
                                    }

                                    @if (!filteredGroups.Any())
                                    {
                                        <div class="text-center py-8 text-gray-500">
                                            <i class="fa-solid fa-search text-3xl mb-2"></i>
                                            <p>Навыки не найдены</p>
                                        </div>
                                    }
                                    else
                                    {
                                        <!-- Трехколоночный макет (для lg экранов) -->
                                        <div class="hidden lg:grid lg:grid-cols-3 gap-4">
                                            <SkillGroupColumn Groups="@filteredGroups.Take(2).ToList()"/>
                                            <SkillGroupColumn
                                                Groups="@filteredGroups.Skip(2).Take(3).ToList()"/>
                                            <SkillGroupColumn Groups="@filteredGroups.Skip(5).ToList()"/>
                                        </div>

                                        <!-- Двухколоночный макет (для экранов от 600px до lg) -->
                                        <div class="hidden sm:grid sm:grid-cols-2 lg:hidden gap-4">
                                            <SkillGroupColumn Groups="@filteredGroups.Take(4).ToList()"/>
                                            <SkillGroupColumn Groups="@filteredGroups.Skip(4).ToList()"/>
                                        </div>

                                        <!-- Одноколоночный макет (для экранов меньше sm) -->
                                        <div class="grid grid-cols-1 sm:hidden gap-4">
                                            <SkillGroupColumn Groups="@filteredGroups.ToList()"/>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Секция Бой -->
                    <div id="combat" class="mb-8">
                        <div class="bg-white rounded-lg overflow-hidden shadow-sm mb-6">
                            <div
                                class="section-header px-4 py-2 bg-gradient-to-r from-primary-600 to-primary-700 flex justify-between items-center cursor-pointer select-none"
                                @onclick='() => ToggleSectionVisibility("combat")'>
                                <div class="flex items-center space-x-3">
                                    <i class="fa-solid fa-gun text-white/70"></i>
                                    <h3 class="text-lg font-semibold text-white" style="margin-bottom: 0;">Оружие и заклинания</h3>
                                </div>
                                <span class="text-white/70 text-sm transition-transform duration-200">@(_sectionVisibility["combat"] ? "▲" : "▼")</span>
                            </div>
                            @if (_sectionVisibility["combat"])
                            {
                                <div class="p-1">
                                    <WeaponComponent Character="@Character"/>
                                    <SpellComponent Character="@Character"/>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Секция Снаряжение -->
                    <div id="equipment" class="mb-8">
                        <div class="bg-white rounded-lg overflow-hidden shadow-sm">
                            <div
                                class="section-header px-4 py-2 bg-gradient-to-r from-primary-600 to-primary-700 flex justify-between items-center cursor-pointer select-none"
                                @onclick='() => ToggleSectionVisibility("equipment")'>
                                <div class="flex items-center space-x-3">
                                    <i class="fa-solid fa-suitcase text-white/70"></i>
                                    <h3 class="text-lg font-semibold text-white" style="margin-bottom: 0;">Снаряжение и финансы</h3>
                                </div>
                                <span class="text-white/70 text-sm transition-transform duration-200">@(_sectionVisibility["equipment"] ? "▲" : "▼")</span>
                            </div>
                            @if (_sectionVisibility["equipment"])
                            {
                                <div class="p-1">
                                    <EquipmentComponent Character="@Character"/>
                                    <FinancesComponent Character="@Character"/>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Секция Биография -->
                    <div id="biography" class="mb-8">
                        <div class="bg-white rounded-lg overflow-hidden shadow-sm">
                            <div
                                class="section-header px-4 py-2 bg-gradient-to-r from-primary-600 to-primary-700 flex justify-between items-center cursor-pointer select-none"
                                @onclick='() => ToggleSectionVisibility("biography")'>
                                <div class="flex items-center space-x-3">
                                    <i class="fa-solid fa-book text-white/70"></i>
                                    <h3 class="text-lg font-semibold text-white" style="margin-bottom: 0;">Биография и заметки</h3>
                                </div>
                                <span class="text-white/70 text-sm transition-transform duration-200">@(_sectionVisibility["biography"] ? "▲" : "▼")</span>
                            </div>
                            @if (_sectionVisibility["biography"])
                            {
                                <div class="p-1">
                                    <BiographyComponent Character="@Character"/>
                                </div>
                            }
                        </div>
                    </div>
                </EditForm>
            }
            else
            {
                <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md">
                    <p class="cm-text-body">Не удалось загрузить или инициализировать данные персонажа.</p>
                </div>
            }
        </div>
    </ChildContent>
    <ErrorContent>
        <div class="alert alert-danger">
            <p class="cm-text-body">Произошла ошибка при загрузке страницы. Пожалуйста, обновите страницу или попробуйте
                позже.</p>
        </div>
    </ErrorContent>
</ErrorBoundary>

@code {
    [Parameter] public Guid? CharacterId { get; set; }
    [Parameter] public Guid? CampaignId { get; set; }

    // Determine if we're in NPC creation mode based on the URL segment after CampaignId
    [Parameter] public string? Npc { get; set; }
    private bool IsNpc => Npc == "npc" || Character?.CharacterType == CharacterType.NonPlayerCharacter;

    private Character? Character { get; set; }
    private CharacterStorageDto? CharacterStorageDto { get; set; }
    private ErrorBoundary? _errorBoundary;
    private bool _isLoading = true;
    private bool _isBusy;
    private readonly NotificationModel _notification = new();
    private CampaignPlayer? CampaignPlayer { get; set; }

    // Section visibility state
    private readonly Dictionary<string, bool> _sectionVisibility = new()
    {
        { "personal", true },
        { "skills", true },
        { "combat", true },
        { "equipment", true },
        { "biography", true }
    };

    // Toggle section visibility
    private void ToggleSectionVisibility(string section)
    {
        if (_sectionVisibility.ContainsKey(section))
        {
            _sectionVisibility[section] = !_sectionVisibility[section];
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _isLoading = true;
            await LoadCharacterDataAsync();
        }
        catch (Exception ex)
        {
            ShowNotification($"Ошибка при инициализации: {ex.Message}", "error");
            Character = CreateNewCharacterTemplate();
            _errorBoundary?.Recover();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadCharacterDataAsync()
    {
        try
        {
            if (CharacterId.HasValue && CharacterId.Value != Guid.Empty)
            {
                CharacterStorageDto = await CharacterService.GetCharacterByIdAsync(CharacterId.Value);
                Character = CharacterStorageDto?.Character;
                if (Character == null)
                {
                    ShowNotification($"Персонаж с ID {CharacterId.Value} не найден. Создан новый шаблон.", "warning");
                    Character = CreateNewCharacterTemplate();
                    CharacterId = null;
                }
            }
            else
            {
                Character = CreateNewCharacterTemplate();
            }

            if (CharacterStorageDto?.CampaignPlayerId is not null)
                CampaignPlayer = await CharacterService.GetCampaignPlayerAsync(CharacterStorageDto.CampaignPlayerId.Value);
        }
        catch (Exception ex)
        {
            ShowNotification($"Ошибка при загрузке персонажа: {ex.Message}", "error");
            Character = CreateNewCharacterTemplate();
        }
    }

    private Character CreateNewCharacterTemplate()
    {
        return new Character
        {
            PersonalInfo = new PersonalInfo
            {
                PlayerName = IsNpc ? "NPC" : CampaignPlayer?.PlayerName ?? "Unknown"
            },
            Characteristics = new Characteristics(),
            Skills = SkillsModel.DefaultSkillsModel(),
            Backstory = string.Empty,
            Biography = new BiographyInfo(),
            Equipment = new Equipment(),
            Finances = new Finances(),
            Weapons = new List<Weapon>(),
            Notes = string.Empty,
            CharacterType = IsNpc ? CharacterType.NonPlayerCharacter : CharacterType.PlayerCharacter
        };
    }

    private async Task SaveCharacterAsync()
    {
        if (Character == null || _isBusy)
            return;

        _isBusy = true;
        ClearNotification();

        try
        {
            if (string.IsNullOrWhiteSpace(Character.PersonalInfo.Name))
            {
                Character.PersonalInfo.Name = IsNpc ? "Безымянный NPC" : "Безымянный";
                ShowNotification($"Имя {(IsNpc ? "NPC" : "персонажа")} не было указано, установлено '{Character.PersonalInfo.Name}'.", "warning");
            }

            // Ensure character type is set correctly
            Character.CharacterType = IsNpc ? CharacterType.NonPlayerCharacter : CharacterType.PlayerCharacter;
            Character.PersonalInfo.PlayerName = IsNpc ? "NPC" : CampaignPlayer?.PlayerName ?? "Unknown";

            if (CharacterId.HasValue && CharacterId.Value != Guid.Empty && Character.Id == CharacterId.Value)
            {
                await CharacterService.UpdateCharacterAsync(Character);
                ShowNotification($"{(IsNpc ? "NPC" : "Персонаж")} успешно обновлен!", "success");
            }
            else
            {
                Character.Id = Guid.Empty;
                var createdCharacter = await CharacterService.CreateCharacterAsync(Character, CampaignPlayer?.Id);

                if (createdCharacter.Id != Guid.Empty)
                {
                    Character.Id = createdCharacter.Id;
                    CharacterId = createdCharacter.Id;
                    ShowNotification($"{(IsNpc ? "NPC" : "Персонаж")} успешно создан!", "success");
                    NavigationManager.NavigateTo($"/character/{createdCharacter.Id}", replace: true);
                }
                else
                {
                    ShowNotification($"Ошибка: Не удалось получить ID созданного {(IsNpc ? "NPC" : "персонажа")}.", "error");
                }
            }
        }
        catch (Exception ex)
        {
            ShowNotification($"Ошибка при сохранении: {ex.Message}", "error");
            _errorBoundary?.Recover();
        }
        finally
        {
            _isBusy = false;
        }
    }

    private void ShowNotification(string message, string type)
    {
        if (string.IsNullOrWhiteSpace(message))
            return;

        _notification.Message = message;
        _notification.Type = type;
    }

    private void ClearNotification()
    {
        _notification.Message = null;
    }

    private void GenerateRandom()
    {
        Character = CharacterGenerationService.GenerateRandomCharacter();

        // Сохраняем имя игрока даже в случайно сгенерированном персонаже
        Character.PersonalInfo.PlayerName = IsNpc ? "NPC" : CampaignPlayer?.PlayerName ?? "No name";

        // Set the character type based on whether we're creating an NPC
        Character.CharacterType = IsNpc ? CharacterType.NonPlayerCharacter : CharacterType.PlayerCharacter;
    }

    private async Task ScrollToSection(string sectionId, bool navMenuOpen = false)
    {
        _navMenuOpen = navMenuOpen;

        try
        {
            await JsRuntime.InvokeVoidAsync("scrollToElement", sectionId);
        }
        catch (Exception)
        {
            // Fallback - если JavaScript не загрузился, попробуем альтернативный метод
            try
            {
                await JsRuntime.InvokeVoidAsync("eval", $@"
                    const element = document.getElementById('{sectionId}');
                    if (element) {{
                        const headerOffset = 120;
                        const elementPosition = element.getBoundingClientRect().top;
                        const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                        window.scrollTo({{ top: offsetPosition, behavior: 'smooth' }});
                    }}
                ");
            }
            catch
            {
                // Игнорируем - скрипт не загрузился
            }
        }
    }

    private void UpdateCharacteristic(AttributeValue value)
    {
        value.UpdateDerived();
        StateHasChanged();
    }

    private void ResetUsedSkills()
    {
        if (Character?.Skills.SkillGroups == null)
            return;

        foreach (var group in Character.Skills.SkillGroups)
        {
            foreach (var skill in group.Skills)
            {
                skill.IsUsed = false;
            }
        }

        ShowNotification("Все использованные навыки сброшены", "success");
        StateHasChanged();
    }

    private bool _navMenuOpen;
    private string _skillSearchQuery = string.Empty;

    private void ToggleNavMenu()
    {
        _navMenuOpen = !_navMenuOpen;
    }

    private void ClearSkillSearch()
    {
        _skillSearchQuery = string.Empty;
    }

    private List<SkillGroup> GetFilteredSkillGroups()
    {
        if (Character?.Skills.SkillGroups == null)
            return new List<SkillGroup>();

        if (string.IsNullOrWhiteSpace(_skillSearchQuery))
            return Character.Skills.SkillGroups;

        var searchTerm = _skillSearchQuery.Trim().ToLowerInvariant();
        var filteredGroups = new List<SkillGroup>();

        foreach (var group in Character.Skills.SkillGroups)
        {
            // Проверяем, соответствует ли название группы поисковому запросу
            var groupNameMatches = group.Name.ToLowerInvariant().Contains(searchTerm);

            // Фильтруем навыки в группе
            var matchingSkills = group.Skills
                .Where(s => s.Name.ToLowerInvariant().Contains(searchTerm))
                .ToList();

            // Если название группы совпадает, включаем все навыки из этой группы
            if (groupNameMatches)
            {
                filteredGroups.Add(group);
            }
            // Иначе, если есть совпадающие навыки, создаем новую группу только с этими навыками
            else if (matchingSkills.Any())
            {
                var filteredGroup = new SkillGroup
                {
                    Name = group.Name,
                    Skills = matchingSkills
                };
                filteredGroups.Add(filteredGroup);
            }
        }

        return filteredGroups;
    }

    private void HandleStatusUpdate(CharacterStatus newStatus)
    {
        if (CharacterStorageDto != null)
        {
            CharacterStorageDto.Status = newStatus;
            ShowNotification($"Статус персонажа изменен на: {newStatus}", "success");
            StateHasChanged();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Ждем, пока JavaScript функции загрузятся
            await Task.Delay(100);
        }

        await base.OnAfterRenderAsync(firstRender);
    }
}