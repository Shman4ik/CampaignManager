@page "/admin/skill-migration"
@using CampaignManager.Web.Components.Features.Characters.Services
@using CampaignManager.Web.Utilities.Services
@attribute [Authorize]

@inject CharacterService CharacterService
@inject IdentityService IdentityService
@inject ILogger<SkillMigrationPage> Logger
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Миграция навыков</PageTitle>

<div class="max-w-4xl mx-auto px-4 py-6">
    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
        <!-- Header -->
        <div class="bg-blue-600 text-white px-6 py-4">
            <h1 class="text-2xl font-bold">Миграция навыков персонажей</h1>
        </div>

        <!-- Content -->
        <div class="p-6">
            @if (!_isAuthorized)
            {
                <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                    <h2 class="text-xl font-bold text-red-700 mb-2">Доступ запрещен</h2>
                    <p class="text-red-600">Только администраторы и мастера игры могут выполнять миграцию навыков.</p>
                </div>
            }
            else
            {
                <div class="mb-6">
                    <h2 class="text-lg font-semibold mb-4">Описание</h2>
                    <p class="text-gray-700 mb-4">
                        Эта одноразовая миграция автоматически свяжет навыки всех персонажей с соответствующими записями
                        в базе данных навыков (SkillModel) по совпадению названий.
                    </p>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <p class="text-sm text-yellow-800">
                            <strong>Внимание:</strong> Миграция обновит все персонажи в базе данных.
                            Навыки, которые уже связаны с базой данных, будут пропущены.
                        </p>
                    </div>
                </div>

                @if (_migrationResult != null)
                {
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3">Результаты миграции</h3>

                        @if (_migrationResult.Success)
                        {
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                <p class="text-green-800 font-semibold mb-2">✓ Миграция завершена успешно!</p>
                            </div>
                        }
                        else
                        {
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                                <p class="text-red-800 font-semibold mb-2">✗ Ошибка миграции</p>
                                <p class="text-red-600 text-sm">@_migrationResult.ErrorMessage</p>
                            </div>
                        }

                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                            <div class="bg-gray-50 rounded-lg p-3">
                                <p class="text-sm text-gray-600">Всего персонажей</p>
                                <p class="text-2xl font-bold text-gray-900">@_migrationResult.TotalCharacters</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3">
                                <p class="text-sm text-gray-600">Обновлено персонажей</p>
                                <p class="text-2xl font-bold text-blue-600">@_migrationResult.CharactersUpdated</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3">
                                <p class="text-sm text-gray-600">Всего навыков</p>
                                <p class="text-2xl font-bold text-gray-900">@_migrationResult.TotalSkills</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3">
                                <p class="text-sm text-gray-600">Навыков связано</p>
                                <p class="text-2xl font-bold text-green-600">@_migrationResult.SkillsLinked</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3">
                                <p class="text-sm text-gray-600">Уже связаны</p>
                                <p class="text-2xl font-bold text-gray-500">@_migrationResult.SkillsAlreadyLinked</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3">
                                <p class="text-sm text-gray-600">Не найдено</p>
                                <p class="text-2xl font-bold text-orange-600">@_migrationResult.SkillsNotFound</p>
                            </div>
                        </div>

                        @if (_migrationResult.MatchStrategies.Any())
                        {
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                <h4 class="font-semibold text-blue-900 mb-2">Стратегии сопоставления:</h4>
                                <div class="space-y-1 text-sm text-blue-800">
                                    @foreach (var strategy in _migrationResult.MatchStrategies)
                                    {
                                        <div class="flex justify-between">
                                            <span>@GetStrategyName(strategy.Key):</span>
                                            <span class="font-semibold">@strategy.Value</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        @if (_migrationResult.SpecializationMatches.Any())
                        {
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
                                <h4 class="font-semibold text-purple-900 mb-2">Сопоставления со специализациями (@_migrationResult.SpecializationMatches.Count):</h4>
                                <div class="max-h-60 overflow-y-auto">
                                    <ul class="list-disc list-inside text-sm text-purple-800">
                                        @foreach (var match in _migrationResult.SpecializationMatches.Distinct().OrderBy(s => s))
                                        {
                                            <li>@match</li>
                                        }
                                    </ul>
                                </div>
                            </div>
                        }

                        @if (_migrationResult.UnmatchedSkills.Any())
                        {
                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                                <h4 class="font-semibold text-orange-900 mb-2">Навыки без совпадений (@_migrationResult.UnmatchedSkills.Count):</h4>
                                <div class="max-h-60 overflow-y-auto">
                                    <ul class="list-disc list-inside text-sm text-orange-800">
                                        @foreach (var skill in _migrationResult.UnmatchedSkills.Distinct().OrderBy(s => s))
                                        {
                                            <li>@skill</li>
                                        }
                                    </ul>
                                </div>
                            </div>
                        }
                    </div>
                }

                <div class="flex gap-4">
                    <Button OnClick="RunMigration"
                            IsDisabled="_isRunning"
                            Variant="info"
                            Icon="@(_isRunning ? "fa-spinner fa-spin" : "fa-database")">
                        @(_isRunning ? "Выполняется..." : "Запустить миграцию")
                    </Button>

                    <Button OnClick="GoBack"
                            Variant="secondary"
                            Icon="fa-arrow-left">
                        Назад
                    </Button>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private bool _isAuthorized;
    private bool _isRunning;
    private SkillMigrationResult? _migrationResult;

    protected override async Task OnInitializedAsync()
    {
        _isAuthorized = await IdentityService.IsKeeper();

        if (!_isAuthorized)
        {
            Logger.LogWarning("Unauthorized access attempt to skill migration page");
        }
    }

    private async Task RunMigration()
    {
        if (_isRunning)
            return;

        try
        {
            _isRunning = true;
            _migrationResult = null;
            StateHasChanged();

            Logger.LogInformation("Starting skill migration from UI");
            _migrationResult = await CharacterService.MigrateCharacterSkillsToSkillModelAsync();
            Logger.LogInformation($"Migration completed: Success={_migrationResult.Success}");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during skill migration");
            _migrationResult = new SkillMigrationResult
            {
                Success = false,
                ErrorMessage = $"Ошибка: {ex.Message}"
            };
        }
        finally
        {
            _isRunning = false;
            StateHasChanged();
        }
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/");
    }

    private string GetStrategyName(string strategyKey)
    {
        return strategyKey switch
        {
            "exact" => "Точное совпадение",
            "base-to-specialized" => "Базовый навык → Специализация",
            "specialized-to-base" => "Специализация → Базовый навык",
            _ => strategyKey
        };
    }
}
