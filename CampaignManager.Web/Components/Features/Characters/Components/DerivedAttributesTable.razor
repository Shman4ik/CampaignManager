@using CampaignManager.Web.Components.Features.Characters.Model
<table class="w-full text-xs">
    <thead>
    <tr class="border-b border-gray-300">
        <th class="text-left font-semibold text-xs text-gray-600 pb-1"></th>
        <th class="w-14 text-center font-semibold text-xs text-gray-600 pb-1">Текущ.</th>
        <th class="w-14 text-center font-semibold text-xs text-gray-600 pb-1">Макс.</th>
    </tr>
    </thead>
    <tbody>
    @foreach (var attr in _attributeRows)
    {
        var percentage = GetPercentage(attr.Attribute);
        var barColor = GetBarColor(attr.ColorClass, percentage);
        var inputClass = GetInputClass(attr.ColorClass, percentage);
        <tr class="border-b border-gray-100">
            <td class="py-1">
                <span class="text-xs font-medium text-gray-700">@attr.Label</span>
            </td>
            <td class="py-1 px-0.5">
                <input type="number" class="@inputClass"
                       @bind="attr.Attribute.Value"/>
            </td>
            <td class="py-1 px-0.5">
                <input type="number" class="w-full text-center px-1 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                       @bind="attr.Attribute.MaxValue"/>
            </td>
        </tr>
        <tr>
            <td colspan="3" class="pb-1.5 pt-0 px-0.5">
                <div class="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden">
                    <div class="h-full rounded-full transition-all duration-500 ease-out @barColor"
                         style="width: @(percentage)%"></div>
                </div>
            </td>
        </tr>
    }
    </tbody>
</table>

@code {
    [Parameter] public required DerivedAttributes Attributes { get; set; }

    private record AttributeRow(string Label, string ColorClass, AttributeWithMaxValue Attribute);

    private List<AttributeRow> _attributeRows = [];

    protected override void OnParametersSet()
    {
        _attributeRows =
        [
            new("ПЗ", "red", Attributes.HitPoints),
            new("ПМ", "blue", Attributes.MagicPoints),
            new("Рассудок", "purple", Attributes.Sanity),
            new("Удача", "green", Attributes.Luck)
        ];
    }

    private static int GetPercentage(AttributeWithMaxValue attr)
    {
        if (attr.MaxValue <= 0)
            return 100;
        return Math.Clamp((int)((double)attr.Value / attr.MaxValue * 100), 0, 100);
    }

    private static string GetBarColor(string colorClass, int percentage) => colorClass switch
    {
        "red" => percentage <= 25 ? "bg-red-600" : percentage <= 50 ? "bg-yellow-500" : "bg-red-500",
        "blue" => "bg-blue-500",
        "purple" => percentage <= 25 ? "bg-red-600" : percentage <= 50 ? "bg-yellow-500" : "bg-purple-500",
        "green" => "bg-green-500",
        _ => "bg-gray-400"
    };

    private static string GetInputClass(string colorClass, int percentage)
    {
        var baseClass = "w-full text-center px-1 py-1 text-xs border rounded focus:outline-none focus:ring-1 focus:ring-blue-500";
        if ((colorClass is "red" or "purple") && percentage <= 25)
            return $"{baseClass} border-red-400 bg-red-50 text-red-700 font-semibold";
        if ((colorClass is "red" or "purple") && percentage <= 50)
            return $"{baseClass} border-yellow-400 bg-yellow-50 text-yellow-700 font-medium";
        return $"{baseClass} border-gray-300";
    }
}