@page "/scenarios"
@using CampaignManager.Web.Components.Features.Scenarios.Model
@using CampaignManager.Web.Components.Features.Scenarios.Services
@attribute [Authorize]
@inject ScenarioService ScenarioService
@inject NavigationManager NavigationManager
@inject ILogger<ScenariosPage> Logger
@rendermode InteractiveServer
<PageTitle>Шаблоны сценариев</PageTitle>

<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Шаблоны сценариев</h1>
        <Button OnClick="@(() => NavigationManager.NavigateTo("/scenarios/new"))" Variant="info" Icon="fa-plus">
            Новый шаблон
        </Button>
    </div>

    @if (_loading)
    {
        <div class="flex justify-center items-center h-64">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
        </div>
    }
    else if (_scenarios.Count == 0)
    {
        <div class="bg-white shadow-md rounded-lg p-6 text-center">
            <p class="text-lg text-gray-600 mb-4">Шаблонов нет.</p>
            <p class="text-gray-500">Создайте новый шаблон.</p>
        </div>
    }
    else
    {
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            @foreach (var scenario in _scenarios)
            {
                <div
                    class="bg-white shadow-md rounded-md overflow-hidden hover:shadow-lg transition-shadow duration-300 flex flex-col h-full">
                    <div class="p-4 flex-grow">
                        <h2 class="cm-h4 mb-3">@scenario.Name</h2>

                        <div class="flex items-center text-sm text-gray-600 mb-3">
                            @if (!string.IsNullOrEmpty(scenario.Era) || !string.IsNullOrEmpty(scenario.Location))
                            {
                                <div class="flex space-x-2">
                                    @if (!string.IsNullOrEmpty(scenario.Era))
                                    {
                                        <span
                                            class="inline-block bg-secondary-100 text-secondary-800 rounded-md px-2 py-0.5 cm-text-sm">
                                            @scenario.Era
                                        </span>
                                    }
                                    @if (!string.IsNullOrEmpty(scenario.Location))
                                    {
                                        <span
                                            class="inline-block bg-primary-100 text-primary-800 rounded-md px-2 py-0.5 cm-text-sm">
                                            @scenario.Location
                                        </span>
                                    }
                                </div>
                            }
                        </div>

                        <p class="cm-text-body text-gray-600 line-clamp-3">
                            @(string.IsNullOrEmpty(scenario.Description)
                                ? "No description provided."
                                : scenario.Description)
                        </p>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 flex justify-between mt-auto border-t border-gray-100">
                        <Button OnClick="@(() => NavigationManager.NavigateTo($"/scenarios/{scenario.Id}"))" Variant="secondary" Size="sm" Icon="fa-eye">
                            View
                        </Button>
                        <div class="flex gap-2">
                            <Button OnClick="@(() => NavigationManager.NavigateTo($"/scenarios/{scenario.Id}/edit"))" Variant="info" Size="sm" Icon="fa-edit">
                                Edit
                            </Button>
                            <Button OnClick="@(() => ConfirmDelete(scenario))" Variant="error" Size="sm" Icon="fa-trash">
                                Delete
                            </Button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- Delete Confirmation Modal -->
@if (_showDeleteModal)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Подтверждение удаления</h3>
                <Button OnClick="() => _showDeleteModal = false" Variant="secondary" Size="sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </Button>
            </div>
            <div class="mb-6">
                <p>Вы уверены что хотите удалить шаблон сценария "<strong>@(_scenarioToDelete?.Name)</strong>"?</p>
                <p class="text-red-600 mt-2">Это действие не возможно отменить.</p>
            </div>
            <div class="flex justify-end space-x-3">
                <Button OnClick="() => _showDeleteModal = false" Variant="secondary">
                    Отмена
                </Button>
                <Button OnClick="DeleteScenario" Variant="error">
                    Удалить
                </Button>
            </div>
        </div>
    </div>
}

@code {
    private List<Scenario> _scenarios = [];
    private bool _loading = true;
    private bool _showDeleteModal;
    private Scenario? _scenarioToDelete;

    protected override async Task OnInitializedAsync()
    {
        await LoadScenarios();
    }

    private async Task LoadScenarios()
    {
        try
        {
            _loading = true;
            _scenarios = await ScenarioService.GetAllScenariosAsync(true);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading scenario templates");
        }
        finally
        {
            _loading = false;
        }
    }

    private void ConfirmDelete(Scenario scenario)
    {
        _scenarioToDelete = scenario;
        _showDeleteModal = true;
    }

    private async Task DeleteScenario()
    {
        if (_scenarioToDelete is null)
        {
            return;
        }

        try
        {
            var success = await ScenarioService.DeleteScenarioAsync(_scenarioToDelete.Id);
            if (success)
            {
                await LoadScenarios();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting scenario {ScenarioId}", _scenarioToDelete.Id);
        }
        finally
        {
            _showDeleteModal = false;
            _scenarioToDelete = null;
        }
    }

}
