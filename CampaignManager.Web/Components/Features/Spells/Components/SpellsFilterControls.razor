@namespace CampaignManager.Web.Components.Features.Spells.Components

<div class="mb-3">
    <div class="flex flex-col sm:flex-row gap-2">
        <input type="text"
               value="@SearchQuery"
               @oninput="HandleSearchInput"
               placeholder="Поиск заклинаний..."
               class="flex-1 px-3 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary-500" />

        <select value="@SelectedTypeFilter"
                @onchange="HandleSpellTypeChanged"
                class="px-3 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary-500">
            <option value="">Все типы</option>
            @foreach (var typeValue in SpellTypeOptions)
            {
                <option value="@typeValue" selected="@(IsSelected(typeValue))">@typeValue</option>
            }
        </select>
    </div>
</div>

@code {
    [Parameter] public string SearchQuery { get; set; } = string.Empty;
    [Parameter] public EventCallback<string> SearchQueryChanged { get; set; }

    [Parameter] public string? SelectedTypeFilter { get; set; }
    [Parameter] public EventCallback<string?> SelectedTypeFilterChanged { get; set; }

    [Parameter] public IEnumerable<string> SpellTypes { get; set; } = Enumerable.Empty<string>();
    [Parameter] public EventCallback OnFiltersChanged { get; set; }

    private IEnumerable<string> SpellTypeOptions
        => SpellTypes
            .Where(type => !string.IsNullOrWhiteSpace(type))
            .Select(type => type.Trim())
            .Concat(!string.IsNullOrWhiteSpace(SelectedTypeFilter) ? new[] { SelectedTypeFilter!.Trim() } : Array.Empty<string>())
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .OrderBy(type => type, StringComparer.OrdinalIgnoreCase);

    private bool IsSelected(string typeValue)
        => !string.IsNullOrWhiteSpace(SelectedTypeFilter) &&
           typeValue.Equals(SelectedTypeFilter, StringComparison.OrdinalIgnoreCase);

    private async Task HandleSearchInput(ChangeEventArgs e)
    {
        var text = (e.Value?.ToString() ?? string.Empty).Trim();
        await SearchQueryChanged.InvokeAsync(text);
        await OnFiltersChanged.InvokeAsync();
    }

    private async Task HandleSpellTypeChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        var normalized = string.IsNullOrWhiteSpace(value) ? null : value.Trim();
        await SelectedTypeFilterChanged.InvokeAsync(normalized);
        await OnFiltersChanged.InvokeAsync();
    }
}
